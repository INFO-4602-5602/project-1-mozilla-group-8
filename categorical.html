<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
		<title>Project 1: Team 8 Categorical Data</title>
		<script type="text/javascript" src="https://d3js.org/d3.v4.min.js"></script>
        <script src="xlsx.full.min.js"></script>

		<style type="text/css">
			.tooltip {
                position: absolute;
                font-size: 12px;
                width: auto;
                height: auto;
                pointer-events: none;
                background-color: lightblue;
            }		
		</style>
</head>

<body>
	<script type="text/javascript">

/////////////////////////////////// DATA LOADING ///////////////////////////////////////////////////////
///////////////////////////// Src: https://github.com/SheetJS/sheetjs //////////////////////////////////

    // Set to Excel data file (which automatically updates itself if new data is put in)
    var url = "SurveyExport_Categorical_Data.xlsx";
    var oReq = new XMLHttpRequest();
    oReq.open("GET", url, true);
    oReq.responseType = "arraybuffer";

    oReq.onload = function(e) {
    var arraybuffer = oReq.response;

    /* Convert data to binary string */
    var data = new Uint8Array(arraybuffer);
    var arr = new Array();
    for(var i = 0; i != data.length; ++i) arr[i] = String.fromCharCode(data[i]);
    var bstr = arr.join("");

    /* Call XLSX */
    var workbook = XLSX.read(bstr, {type:"binary"});

    var first_sheet_name = workbook.SheetNames[1];
    /* Get the (2nd) Excel worksheet */
    var worksheet = workbook.Sheets[first_sheet_name];
    var json_vers = XLSX.utils.sheet_to_json(worksheet,{raw:true});

    // Create array of 10 objects to store information (collected dynamically from excel worksheet)
    var n = 10;
    var infos = new Array();
    for (var i = 0; i < n; i++)
        infos.push(new Object());

    // Populate each object with information, where each object represents one bubble data set (one total rating)
    for (var j = 0; j < n; j++){
        infos[j] = {
            "children": [{"Name":"Price","Count":json_vers[j].Price,"Priority":j+1},
                {"Name":"Features","Count":json_vers[j].Features,"Priority":j+1},
                {"Name":"Safety","Count":json_vers[j].Safety,"Priority":j+1},
                {"Name":"Security","Count":json_vers[j].Security,"Priority":j+1},
                {"Name":"Privacy","Count":json_vers[j].Privacy,"Priority":j+1},
                {"Name":"Reliability","Count":json_vers[j].Reliability,"Priority":j+1},
                {"Name":"User Reviews","Count":json_vers[j]["User Reviews"],"Priority":j+1},
                {"Name":"Expert Rec.","Count":json_vers[j]["Expert Rec."],"Priority":j+1},
                {"Name":"Friend/Fam. Rec.","Count":json_vers[j]["Friend/Fam. Rec."],"Priority":j+1},
                {"Name":"Convenience","Count":json_vers[j].Convenience,"Priority":j+1}]
        };
    }

  console.log(infos); // Put entire array of objects onto screen for verification
////////////////////////////////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////////////////////////////////

		// Total image size = (length x length) pixels
		var length = 600;

		// Map color by integers using schemeCategory10 (10 circles)
		var color = d3.scaleOrdinal(d3.schemeCategory10);

        // Create set of bubbles using data; padding puts distance between each bubble
        var bubble = d3.pack(infos[6])
            .size([length, length])
            .padding(2.0);

        // Nodes (of a storage tree) store array of entire infos[0]
        var nodes = d3.hierarchy(infos[6])
            .sum(function(d) { return d.Count; });

        // SVG graphic variable holding desired attributes
        var svg = d3.select("body")
            .append("svg")
            .attr("width", length)
            .attr("height", length)
            .attr("class", "bubble");

        // Initialize tooltip variable for user interactivity
        var tooltip = d3.select("body")
            .append("div")
                .style("opacity", 0)
                .attr("class", "tooltip")
                .style("background-color", "lightblue")
                .style("border-radius", "5px")
                .style("padding", "10px")
                .style("color", "black")

        // Output tooltip /w relevant information when user first hovers over any new bubble
        var showTooltip = function(d) {
            var outputText = d.data.Count + " people rated " + d.data.Name + "<br>";
            outputText += " as priority #: " + d.data.Priority + "<br>";
            tooltip
                .transition()
                .duration(200)
            tooltip
                .style("opacity", 1)
                .html(outputText)
                .style("left", (d3.event.pageX + 15) + "px")
                .style("top", (d3.event.pageY - 28) + "px")
        }

        // Update location of tooltip box whenever user moves the mouse over the same bubble
        var moveTooltip = function(d) {
            tooltip
                .style("left", (d3.event.pageX + 15) + "px")
                .style("top", (d3.event.pageY - 28) + "px")
        }

        // Hide tooltip (opacity=0) when mouse goes off the currrent bubble
        var hideTooltip = function(d) {
            tooltip
                .transition()
                .duration(200)
                .style("opacity", 0)
        }

        // Defining each individual node/circle
        var node = svg.selectAll(".node")
            .data(bubble(nodes).descendants())
            .enter()
            .filter(function(d){
                return  !d.children
            })
            .append("g")
            .attr("class", "node")
            .on("mouseover", showTooltip)
            .on("mousemove", moveTooltip)
            .on("mouseleave", hideTooltip)
            .attr("transform", function(d) {
                return "translate(" + d.x + "," + d.y + ")";
            });

        // Titles each node/bubble for in-script information
        node.append("title")
            .text(function(d) {
                return d.Name + ": " + d.Count;
           });

        // Function that returns radius of each bubble for output onto screen
        node.append("circle")
            .attr("r", function(d) {
                return d.r;
            })
        // Function that returns color for each bubble for output onto screen
            .style("fill", function(d,i) {
                return color(i);
            });

        // Label each individual bubble /w Name and format it to fit the bubble
        node.append("text")
            .attr("dy", ".2em")  // Vertical distance between "name" and "count"
            .style("text-anchor", "middle") // Center text on bubble
            .text(function(d) {
                return d.data.Name.substring(0, d.r / 3);
            })
            .attr("font-family", "sans-serif")
            .attr("font-size", function(d){  // Font size in terms of bubble radius
                return d.r/4.5;
            })
            .attr("fill", "black"); // Color of text

        // Add on count (which we pre-calculated) to each individual bubble with good looking format
        node.append("text")
            .attr("dy", "1.3em") // Vertical distance between "name" and "count"
            .style("text-anchor", "middle")  // Center text on bubble
            .text(function(d) {
                return d.data.Count;
            })
            .attr("font-family",  "Gill Sans", "Gill Sans MT")
            .attr("font-size", function(d){  // Font size in terms of bubble radius
                return d.r/6;
            })
            .attr("fill", "black");  // Color of text

        d3.select(self.frameElement)
            .style("height", length + "px");
            
    } // End of Excel sheet read-in

        oReq.send(); // End of Excel Sheet read-in (from source)

	</script>
</body>
</html>